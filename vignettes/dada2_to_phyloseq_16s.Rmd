---
title: "Convert 16S data to Phyloseq with metadata"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{dada2-to-phyloseq-16s}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_knit$set(
  root.dir = "/projectnb/dietzelab/zrwerbin/NEON_soil_microbe_processing"
)
```

The goal of this vignette is to merge various NEON data products to link the outputs of the DADA2 pipeline (e.g. non-chimeric sequence table, taxonomic table) to environmental/sample data. We assume that you have already run the entire pipeline and have a sequence table and taxonomic table prepared.

First, load necessary packages, and parameters file.
```{r}
library(phyloseq)
library(dplyr)

# Load parameters and utilities and create soil database if necessary
source("./R/utils.R")
source("./code/params_zoey.R")
```

Next, we load in the outputs from dada2.
```{r}
# Load combined sequence table and taxonomic table
seqtab_orig <- readRDS("./data/NEON_16S_seqtab_nochim.rds")
taxa_orig <- readRDS("./data/NEON_16S_tax.rds")
```

Now, we add sequence metadata. This is necessary for correcting the sample names.
```{r}
#sampledata_full <- downloadSequenceMetadata(outDir="./data", startYrMo="2013-06",endYrMo="2020-11")
sampledata_full <- read.csv("/projectnb/dietzelab/zrwerbin/NEON_soil_microbe_processing/data/mmg_soilMetadata_all_2020-11-05.csv")
sampledata <- sampledata_full %>% filter(targetGene == "16S") %>% 
	distinct(internalLabID, processedSeqFileName, dnaSampleID, .keep_all =T) 
sampledata <- sampledata %>% 
	select(sequencerRunID, dnaSampleID, internalLabID, dataQF.rawFiles, 
				 siteID, collectDate, plotID, deprecatedVialID, geneticSampleID)
# Fix date column
sampledata$date_ymd <- as.Date(format(as.Date(sampledata$collectDate, format="%Y-%m-%dT%H:%MZ"), "%Y-%m-%d"))
```

If you want associated data - such as temperature, moisture, pH, and other chemistry (when possible) - run this section as well. *TODO: edit according to however we decide to combine* 
```{r}
#soils <- downloadRawSoilData(startYrMo="2013-06",endYrMo="2020-11",outdir="./data")
soils_orig <- read.csv("./data/sls_soilData_2020-11-05.csv")
soils <- soils_orig %>% select(domainID, siteID, plotID, plotType, nlcdClass, collectDate, sampleTiming, standingWaterDepth, sampleID, 
													horizon, soilTemp, litterDepth, sampleTopDepth, sampleBottomDepth, geneticSampleID, soilInCaClpH)
sampledata <- merge(sampledata, soils, all.x=T)
# Add rownames to sample data table
rownames(sampledata) <- make.unique(as.character(sampledata$dnaSampleID))
```


```{r}
# Remove low-abundance taxa (optional - this step is now in dada2 vignette)
keep <- which(colSums(seqtab_orig) > 20)
seqtab <- seqtab_orig[,keep]
print(dim(seqtab))

# Remove low-quality samples (optional)
keep <- which(rowSums(seqtab) > 5000)
seqtab <- seqtab[keep,]
print(dim(seqtab))
```

The `phyloseq` R package uses row names to match up data. Let's get the row names consistent between the sequence table and sample data.
```{r}
# Fix rownames on sequence table
seq.internalLabID <- gsub("^run....._|_16S|_.....$", "", rownames(seqtab)) 
seq.internalLabID <- gsub("-","_",seq.internalLabID)
seq.sampleID <- sampledata[match(seq.internalLabID, sampledata$internalLabID),]$dnaSampleID
rownames(seqtab) <- make.unique(as.character(seq.sampleID))

# Subset to samples present in both dataframes
common_samples <- intersect(rownames(sampledata), rownames(seqtab))
sampledata <- sampledata[common_samples,]
seqtab <- seqtab[common_samples,]
```

Now we put it all together!
```{r}
# Check rowname agreement for phyloseq
#identical(rownames(seqtab), rownames(sampledata))

# Combine into phyloseq object
ps <- phyloseq(otu_table(seqtab, taxa_are_rows=FALSE),
               sample_data(sampledata),
               tax_table(taxa_orig))

# store the DNA sequences of our ASVs in the refseq slot of the phyloseq object,
# and then rename our taxa to a short string
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))

# Print phyloseq summary.
ps 
```

Don't forget to save! If the saved object takes up too much memory, consider removing or consolidating taxa, using glom functions. The `speedyseq` package is also useful for manipulating large phyloseq datasets.
```{r}
saveRDS(ps, "./data/NEON_16S_phyloseq_full.rds")

# Create a smaller subset
# Remove taxa not seen more than 3 times in at least 10 of the samples. 
# This protects against an OTU with small mean & trivially large C.V. 
# (from phyloseq tutorial)
ps_subset = filter_taxa(ps, function(x) sum(x > 3) > 10, TRUE)
saveRDS(ps_subset, "./data/NEON_16S_phyloseq_subset.rds")


```