---
title: "Download NEON Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{download-neon-data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_knit$set(
  root.dir = rprojroot::find_rstudio_root_file()
)
```


This vignette demonstrates how to use the functions and parameters in this package to download the specific scope NEON soil microbe marker gene sequence data and associated data relevant to your analysis. 

# Dependencies

To begin, ensure that you have installed all dependencies.

From CRAN:
```{r}
install.packages("dplyr")
install.packages("neonUtilities")
```

In addition, source files associated with this package:

```{r}
source("./R/utils.R")
source("./code/params.R")
```

# Set up directories

Set up the directory structure associated with the various NEON data products. The structure will depend on what you have written in `params.R`. We recommend setting the `PRESET_OUTDIR_*` parameters to be filepaths belonging to the same parent directory. For example:

```
PRESET_OUTDIR_SEQUENCE = "/data/NEON/raw_sequence"
PRESET_OUTDIR_SEQMETA = "/data/NEON/sequence_metadata"
PRESET_OUTDIR_SOIL = "/data/NEON/soil"
```

You do not have to manually create these directories before running this script -- the script will do so for you.

```{r}
# If preset output directories do not exist, create them
if(!dir.exists(PRESET_OUTDIR_SEQUENCE)) dir.create(PRESET_OUTDIR_SEQUENCE, recursive=TRUE)
if(!dir.exists(PRESET_OUTDIR_SEQMETA)) dir.create(PRESET_OUTDIR_SEQMETA, recursive=TRUE)
if(!dir.exists(PRESET_OUTDIR_SOIL)) dir.create(PRESET_OUTDIR_SOIL, recursive=TRUE)

# If preset output directories for ITS and 16S data do not exist, create them
BASE_DIR <- PRESET_OUTDIR_SEQUENCE
if(!dir.exists(file.path(BASE_DIR, "ITS"))) dir.create(file.path(BASE_DIR, "ITS"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "16S"))) dir.create(file.path(BASE_DIR, "16S"), recursive=TRUE)

# Create intermediary directories for ITS and 16S data in the middle
# of being processed
if(!dir.exists(file.path(BASE_DIR, "ITS", "0_unzipped"))) dir.create(file.path(BASE_DIR, "ITS", "0_unzipped"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "ITS", "1_filtN"))) dir.create(file.path(BASE_DIR, "ITS", "1_filtN"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "ITS", "2_cutadapt"))) dir.create(file.path(BASE_DIR, "ITS", "2_cutadapt"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "ITS", "3_filtered"))) dir.create(file.path(BASE_DIR, "ITS", "3_filtered"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "ITS", "4_seqtabs"))) dir.create(file.path(BASE_DIR, "ITS", "4_seqtabs"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "ITS", "track_reads"))) dir.create(file.path(BASE_DIR, "ITS", "track_reads"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "16S", "0_unzipped"))) dir.create(file.path(BASE_DIR, "16S", "0_unzipped"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "16S", "1_filtN"))) dir.create(file.path(BASE_DIR, "16S", "1_filtN"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "16S", "2_cutadapt"))) dir.create(file.path(BASE_DIR, "16S", "2_cutadapt"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "16S", "3_filtered"))) dir.create(file.path(BASE_DIR, "16S", "3_filtered"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "16S", "4_seqtabs"))) dir.create(file.path(BASE_DIR, "16S", "4_seqtabs"), recursive=TRUE)
if(!dir.exists(file.path(BASE_DIR, "16S", "track_reads"))) dir.create(file.path(BASE_DIR, "16S", "track_reads"), recursive=TRUE)
```

# Download data

All of the downloading functions will refer to the subsetting parameters in `params.R` by default. These parameters may look like the following:

```
PRESET_SITES = "all" # Default "all". Can also be character vector of 4-letter NEON site codes e.g. c('ONAQ','RMNP')
PRESET_START_YR_MO = "2016-01"
PRESET_END_YR_MO = format(Sys.Date(), "%Y-%m")
TARGET_GENE = "16S" # Must be "ITS", "16S", or "all"
SEQUENCING_RUNS = c('C25G9', 'B69PP') # Default "all". Can also be character vector of 5-letter NEON sequencing run IDs e.g. c('B69RF','BTP4N')
```

If time and space are not issues for you, you can download the entire dataset over the course of a few hours. However, these subsetting parameters can be used to specify which parts of the data you are interested in keeping for your analysis.

In addition, the following parameters will be used with the downloading functions by default:

```
PRESET_CHECK_FILE_SIZE = FALSE
PRESET_RETURN_DATA = TRUE
```

`PRESET_CHECK_FILE_SIZE` determines whether the script will give you a warning with an estimated file size before downloading a file. `PRESET_RETURN_DATA` determines whether the downloading functions return data as an R object, or simply downloads data to the specified output directory and returns no value.

You can change any of these parameters on-the-fly by entering different arguments to the downloading functions. For more info, see the help pages for `downloadSequenceMetadata()`, `downloadRawSequenceData()`, and `downloadRawSoilData()`.

## Download metadata

The `downloadSequenceMetadataRev()` function downloads NEON data product DP1.10108 ("Soil microbe marker gene sequences") and assembles it using the `neonUtilities` package. This data product contains a number of tables related to accessing raw sequence data. A joined table containing information about the raw data URLs and the marker gene sequencing parameters is returned by this function. In the following example, we run `downloadSequenceMetadataRev()` with a number of arguments to narrow the range of data to be downloaded. Unspecified arguments will take on the defaults defined in `params.R`.

```{r}
meta <- downloadSequenceMetadataRev(startYrMo = "2018-03", endYrMo = "2018-07", sites = c("OSBS", "CPER", "CLBJ"), targetGene = "16S")
```

## Download raw sequence data

Now that we have the metadata table loaded into memory, we retrieve a table of unique raw data files and their sequencing run IDs. 

```{r}
downloaded <- downloadRawSequenceData(meta, outdir="/data/ZHULAB/NEON_DOB/test_08-05-2020")
```

## Reorganize and rename the downloaded files

Get the names of all downloaded files, and the sequencing run ID associated with each file.

```{r}
zipF <- list.files(path = BASE_DIR, pattern = "fastq", full.names = TRUE)
runIDs <- meta$sequencerRunID[match(basename(zipF), meta$rawDataFileName)]
```

Unzip each file (if necessary), append the run ID to the beginning of the filenames, and move files to subfolders within your preset sequence directory according to their target gene. The terminal directory name for either target gene will be `0_unzipped`.

```{r}
for(i in 1:length(zipF)) {
  # get run ID associated with the zip file
  runID <- runIDs[i]
  if(is.na(runID)) next

  # unzip files
  if(grepl("fastq.gz", zipF[i])) {
    unzip(zipF[i], exdir = BASE_DIR)
  } else {
    untar(zipF[i], list=FALSE, exdir = BASE_DIR)
  }

  # list all files after unzipping
  # This regex matches all files with basenames that do NOT begin with "run" and which end with ".fastq"
  unzippedF_ITS <- grep("/(?!run)[^/]*_ITS[^/]*fastq", list.files(path = BASE_DIR, recursive=TRUE, full.names=TRUE), perl=TRUE, value=TRUE)
  unzippedF_16S <- grep("/(?!run)[^/]*_16S[^/]*fastq", list.files(path = BASE_DIR, recursive=TRUE, full.names=TRUE), perl=TRUE, value=TRUE)

  # rename all unzipped files by appending sequencer run ID
  unzippedF_ITS_rename <- file.path(BASE_DIR, "ITS", "0_unzipped", paste0("run", runID, "_", basename(unzippedF_ITS)))
  unzippedF_16S_rename <- file.path(BASE_DIR, "16S", "0_unzipped", paste0("run", runID, "_", basename(unzippedF_16S)))
  if(length(unzippedF_ITS) > 0) file.rename(unzippedF_ITS, unzippedF_ITS_rename)
  if(length(unzippedF_16S) > 0) file.rename(unzippedF_16S, unzippedF_16S_rename)
}
```

